# Fix date round-trip bug and add dedup test coverage

*Date: 2026-02-11 2002*

## Why

PR #229 review feedback identified two categories of issues:

1. **P1 date round-trip bug**: `getTimeInRangeForRange` and `getMealBoluses` parsed Pacific date strings with `new Date("YYYY-MM-DD")` which interprets them as UTC midnight. On Lambda (us-east-1), this shifts the query window back by 8 hours — "today" would include yesterday's readings.

2. **Missing test coverage**: The dedup logic (`stripMarkup`, `getRecentInsightContents`) had no tests.

## How

- Replaced `new Date(dateStr).getTime()` with `getStartOfDayInTimezone(dateStr)` in both `glucose.ts` and `treatment.ts` — this parses YYYY-MM-DD as midnight in Pacific time, not UTC
- Added tests for `stripMarkup` (10 cases including nested/malformed tags)
- Added tests for dedup matching (case-insensitive, markup-stripped comparison)
- Added tests for `getRecentInsightContents` (6 cases including query shape and error handling)
- Added tests for `getStartOfDayInTimezone` including a regression test proving the round-trip bug

## Key Design Decisions

- `getStartOfDayInTimezone` already existed in keys.ts — just needed to use it
- Two Copilot suggestions (stripMarkup regex, dedup try-catch) were already fixed before merge
- Tests for `stripMarkup` duplicate the function inline since it's not exported — acceptable for a pure function test

## What's Next

- Monitor TIR and meal bolus queries post-deploy to confirm correct date boundaries
