# CI/CD Pipeline Fixes

*Date: 2026-01-14 2300*

## Why

GitHub Actions CI and Deploy workflows were failing due to multiple issues:
1. pnpm version conflicts
2. Missing TypeScript type declarations
3. SST/Pulumi version conflicts
4. Missing IAM permissions for deployment

## How

### pnpm Version Conflict
Removed explicit `version: 9` from pnpm/action-setup - let it use the version from `packageManager` in package.json to avoid conflicts.

### TypeScript Type Declarations

**Web package**: Added `vite-env.d.ts` for Vite's `import.meta.env` types (the SST-generated `sst-env.d.ts` is gitignored).

**Functions package**: Added `sst-types.d.ts` at repo root declaring SST's `Resource` interface and const. The SST-generated types are gitignored and only exist after running `sst dev` or `sst deploy`.

**Connect handler**: Fixed `queryStringParameters` type - not in base WebSocket event type but available on $connect.

### Test Configuration

- Added `packages/core/src/pixoo.test.ts` with tests for frame creation and encoding
- Configured vitest with `--passWithNoTests` for packages without tests (web, functions, relay)

### SST/Pulumi Version Conflict

GitHub Actions runners have Pulumi pre-installed at `/usr/local/bin/pulumi*`. This conflicts with SST v3's bundled Pulumi version, causing `flag provided but not defined: -root` errors.

**Fix**: Remove system Pulumi binaries before running SST deploy:
```yaml
- name: Remove system Pulumi to avoid conflicts
  run: |
    sudo rm -f /usr/local/bin/pulumi* || true
    sudo rm -rf /home/runner/.pulumi || true
```

### IAM User for CI/CD

Created dedicated `signage-ci` IAM user with least-privilege policy instead of using personal credentials.

**Policy allows**:
- SSM parameters (`/sst/*`) - SST state storage
- S3 buckets (`sst-*`, `signage-*`) - deployment artifacts and static site
- Lambda functions (`signage-*`)
- DynamoDB tables (`signage-*`)
- API Gateway (all - no resource-level restrictions available)
- CloudFront distributions
- CloudWatch Logs
- IAM roles (`signage-*`) - for Lambda execution roles

**Policy created via**:
```bash
aws iam create-user --user-name signage-ci
aws iam create-policy --policy-name signage-ci-deploy --policy-document file://policy.json
aws iam attach-user-policy --user-name signage-ci --policy-arn arn:aws:iam::ACCOUNT:policy/signage-ci-deploy
aws iam create-access-key --user-name signage-ci
```

**GitHub secrets set via**:
```bash
echo "$ACCESS_KEY_ID" | gh secret set AWS_ACCESS_KEY_ID
echo "$SECRET_ACCESS_KEY" | gh secret set AWS_SECRET_ACCESS_KEY
```

## Commits

- `ae6fe17` Fix CI/CD pnpm version conflict
- `aca13e4` Add vite-env.d.ts for Vite environment types in CI
- `05d9420` Add SST type stubs for CI builds
- `2f1d436` Add core tests and fix vitest for empty packages
- `52437b6` Remove system Pulumi binaries before SST deploy

## Result

- **CI workflow**: Tests, builds, type checks all passing
- **Deploy workflow**: Successfully deploys to AWS via SST
- **Security**: Dedicated IAM user with minimal required permissions
